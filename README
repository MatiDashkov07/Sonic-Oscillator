# ğŸ›ï¸ The Sonic Oscillator

**A bare-metal digital synthesizer built from scratch on ESP32-C3**

![Platform](https://img.shields.io/badge/Platform-ESP32--C3-blue?style=flat-square&logo=espressif)
![Framework](https://img.shields.io/badge/Framework-Arduino-00979D?style=flat-square&logo=arduino)
![Version](https://img.shields.io/badge/Version-3.1-green?style=flat-square)
![License](https://img.shields.io/badge/License-MIT-yellow?style=flat-square)
![Status](https://img.shields.io/badge/Status-Production-brightgreen?style=flat-square)

---

## ğŸ“– Overview

The Sonic Oscillator is an embedded digital synthesizer that demonstrates real-time audio synthesis, DSP filtering, and professional UI design on a resource-constrained microcontroller. Built entirely from scratch using a bottom-up methodology, this project serves as both a functional musical instrument and a learning platform for embedded systems development.

**Why this project?**

This isn't just another Arduino buzzer sketch. It's a complete exploration of what happens when you push a $4 microcontroller to generate real-time audio â€” including the electrical engineering challenges (GPIO current limits, inductive loads, signal integrity) that tutorials never mention.

---

## âœ¨ Features

### Audio Engine
- **Multi-Waveform Synthesis** â€” Square, Saw, Triangle, and Chaotic Noise modes
- **Real-Time DSP** â€” Software low-pass filter eliminates input jitter for smooth frequency control
- **Protected Frequency Range** â€” Automatic clamping prevents LEDC peripheral instability below 350Hz

### User Interface
- **OLED Display** â€” 128x32 pixel screen with procedurally-drawn graphics (zero bitmap storage)
- **Rotary Encoder Navigation** â€” Interrupt-driven input ensures no missed steps
- **Smart Button** â€” Time-domain multiplexing distinguishes short press (select) from long press (mute)
- **Safe Boot** â€” System always starts muted to prevent audio surprises

### System Design
- **State Machine Architecture** â€” Clean separation between Menu, Playing, and Mute states
- **30 FPS Display Cap** â€” Prevents I2C bus saturation while maintaining responsive feel
- **Timeout Auto-Return** â€” Menu automatically returns to playing mode after 10 seconds of inactivity

---

## ğŸ”§ Hardware

### Bill of Materials

| Component | Specification | Purpose |
|-----------|---------------|---------|
| ESP32-C3 | RISC-V, 160MHz | Main controller |
| OLED Display | SSD1306, 128x32, I2C | User interface |
| Rotary Encoder | KY-040 with push button | Navigation & selection |
| Potentiometer (x2) | 10kÎ© linear | Pitch & tone control |
| Piezo Buzzer | HW-508 module | Audio output |
| NPN Transistor | 2N2222 / BC547 | Load switching |
| Flyback Diode | 1N4148 / 1N5819 | Inductive protection |
| Resistors | 1kÎ© (base), 150Î© (protection) | Current limiting |

### Schematic

```
                                    +3.3V
                                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                             â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚  OLED   â”‚                   â”‚  Buzzer â”‚
   â”‚ SSD1306 â”‚                   â”‚  HW-508 â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚ I2C                         â”‚
   SDAâ”€â”€â”¤ (GPIO 18)                   â”‚
   SCLâ”€â”€â”¤ (GPIO 19)              â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â”‚                        â”‚ Flyback â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                   â”‚  Diode  â”‚
   â”‚         â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
   â”‚ ESP32-C3â”‚                        â”‚
   â”‚         â”‚                        â”‚ Collector
   â”‚  GPIO 4 â”œâ”€â”€â”€â”€[1kÎ©]â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚         â”‚             â”‚    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚  GPIO 0 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”‚ 2N2222â”‚
   â”‚  GPIO 1 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”‚  NPN  â”‚
   â”‚         â”‚             â”‚    â””â”€â”€â”€â”¬â”€â”€â”€â”˜
   â”‚  GPIO 5 â”œâ”€â”€â”          â”‚        â”‚ Emitter
   â”‚  GPIO 6 â”œâ”€â”€â”¼â”€ Encoder â”‚        â”‚
   â”‚  GPIO 7 â”œâ”€â”€â”˜          â”‚       GND
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                      Potentiometers
                       (Pitch/Tone)
```

### Pin Configuration

```cpp
// Display (I2C)
#define I2C_SDA         18
#define I2C_SCL         19

// Controls
const int SW_PIN        = 7;    // Encoder button
const int PIN_DT        = 5;    // Encoder data
const int PIN_CLK       = 6;    // Encoder clock
const int POT_PIN_PITCH = 0;    // Frequency control
const int POT_PIN_TONE  = 1;    // Duty cycle control

// Output
const int BUZZER_PIN    = 4;    // PWM output
```

---

## ğŸš€ Installation

### Prerequisites

- [PlatformIO](https://platformio.org/) or Arduino IDE
- ESP32 board support package
- USB-C cable for programming

### Quick Start

```bash
# Clone the repository
git clone https://github.com/yourusername/sonic-oscillator.git
cd sonic-oscillator

# Using PlatformIO (recommended)
pio run -t upload

# Or using Arduino IDE
# 1. Open src/main.cpp
# 2. Select "ESP32C3 Dev Module" as board
# 3. Click Upload
```

### Dependencies

```ini
# platformio.ini
[env:esp32-c3]
platform = espressif32
board = esp32-c3-devkitm-1
framework = arduino
lib_deps = 
    adafruit/Adafruit GFX Library@^1.11.5
    adafruit/Adafruit SSD1306@^2.5.7
```

---

## ğŸ—ï¸ Architecture

### Software Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Main Loop                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Input     â”‚    State     â”‚        Output         â”‚
â”‚  Processing  â”‚   Machine    â”‚      Generation       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Button     â”‚ â€¢ UI State   â”‚ â€¢ Audio Engine        â”‚
â”‚ â€¢ Encoder    â”‚ â€¢ Mute State â”‚ â€¢ Display Renderer    â”‚
â”‚ â€¢ ADC + LPF  â”‚ â€¢ Timeout    â”‚ â€¢ LEDC PWM            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### State Machines

**UI States:**
```
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚         Encoder             â”‚
           â”‚         Movement            â”‚
           â–¼                             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚    MENU     â”‚â”€â”€â”€â”€ Select â”€â”€â–¶  PLAYING   â”‚
    â”‚             â”‚â—€â”€â”€ Timeout â”€â”€â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Mute States:**
```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Long Press  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ACTIVE    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    MUTED    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Algorithms

**Input Smoothing (Exponential Moving Average):**
```cpp
smoothedValue = Î± Ã— newValue + (1 - Î±) Ã— smoothedValue
// Î± = 0.1 provides strong smoothing with acceptable latency
```

**Encoder Debounce (ISR-based):**
```cpp
void IRAM_ATTR updateEncoder() {
    if (millis() - lastInterruptTime > 10) {  // 10ms lockout
        virtualPosition += (digitalRead(CLK) != digitalRead(DT)) ? 1 : -1;
        lastInterruptTime = millis();
    }
}
```

---

## ğŸ“Š Technical Challenges Solved

### 1. GPIO Current Collapse
**Problem:** Direct buzzer connection caused voltage drop from 3.3V to 1.5V  
**Cause:** Buzzer demanded 220mA; GPIO can only supply 40mA  
**Solution:** NPN transistor driver isolates load from GPIO

### 2. Phantom Duty Cycle
**Problem:** Oscilloscope showed 12% duty cycle instead of commanded 50%  
**Cause:** `ledcWriteTone()` and `ledcWrite()` conflict  
**Solution:** Use `ledcChangeFrequency()` + `ledcWrite()` pair

### 3. Inductive Kickback
**Problem:** -400mV spikes exceeded GPIO absolute maximum rating  
**Cause:** Inductor back-EMF during switching  
**Solution:** Flyback diode clamps negative excursions

---

## ğŸ—ºï¸ Roadmap

### âœ… Phase 1: Core Synthesizer (Complete)
- [x] Hardware PWM audio generation
- [x] OLED display with procedural graphics
- [x] Rotary encoder navigation
- [x] Multi-waveform modes
- [x] DSP input filtering
- [x] State machine architecture

### ğŸ”„ Phase 2: Code Refactoring (In Progress)
- [ ] Modular class-based architecture
- [ ] Separate AudioEngine, InputManager, DisplayManager
- [ ] Elimination of global variables
- [ ] Non-blocking timing throughout

### ğŸ“‹ Phase 3: Teensy 4.1 Migration (Planned)
- [ ] Port to ARM Cortex-M7 @ 600MHz
- [ ] True DAC output for authentic waveforms
- [ ] Teensy Audio Library integration
- [ ] ADSR envelope generator

### ğŸ”® Phase 4: Advanced Features (Future)
- [ ] LFO for automatic modulation
- [ ] Step sequencer for pattern playback
- [ ] Resonant filter with cutoff control
- [ ] FFT spectrum visualization

---

## ğŸ“ Project Structure

```
sonic-oscillator/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ main.cpp              # Main application code
â”œâ”€â”€ include/
â”‚   â””â”€â”€ config.h              # Pin definitions & constants
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ assets/               # Images and media
â”‚   â”œâ”€â”€ EXECUTIVE_SUMMARY.md  # Detailed technical documentation
â”‚   â””â”€â”€ SCHEMATIC.pdf         # Circuit diagram
â”œâ”€â”€ hardware/
â”‚   â””â”€â”€ BOM.csv               # Bill of materials
â”œâ”€â”€ platformio.ini            # Build configuration
â”œâ”€â”€ LICENSE
â””â”€â”€ README.md
```

---

## ğŸ¤ Contributing

This is primarily a personal learning project, but suggestions and discussions are welcome! Feel free to:

- Open an issue for bugs or suggestions
- Submit a PR for improvements
- Fork and adapt for your own projects

---

## ğŸ“„ License

This project is licensed under the MIT License â€” see the [LICENSE](LICENSE) file for details.

---

## ğŸ™ Acknowledgments

- **Adafruit** â€” For excellent GFX and SSD1306 libraries
- **Espressif** â€” For the ESP32-C3 platform and documentation
- **PJRC** â€” For Teensy inspiration and Audio Library (upcoming)

---

**Built with â¤ï¸ and an oscilloscope**

*Part of the journey toward autonomous systems engineering*